<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cribbage Counter</title>
  <link rel="icon" type="image/png" href="app_icon2.png">
  <link rel="apple-touch-icon" href="app_icon2.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#145227">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Cribbage">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #145227;
      --panel:     #1a6b34;
      --accent:    #27ae60;
      --highlight: #f1c40f;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
      align-items: flex-start;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Page root & tab bar
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .page-root {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 1100px;
    }

    .tab-bar {
      display: flex;
      gap: 6px;
      margin-bottom: 14px;
      align-items: center;
    }

    .tab-btn {
      padding: 9px 22px;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      color: rgba(255,255,255,0.55);
      background: rgba(0,0,0,0.22);
      transition: color 0.15s, background 0.15s, box-shadow 0.15s;
    }
    .tab-btn.active {
      color: #fff;
      background: var(--panel);
      box-shadow: 0 3px 10px rgba(0,0,0,0.35);
    }
    .tab-btn:hover:not(.active) {
      color: rgba(255,255,255,0.88);
      background: rgba(0,0,0,0.32);
      filter: none;
    }
    .tab-btn:active { transform: translateY(1px); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Shared panel styles
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .panel-box {
      background: var(--panel);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5);
    }

    h1 {
      color: #fff;
      text-align: center;
      font-size: 2rem;
      margin-bottom: 4px;
      letter-spacing: -0.5px;
    }

    .subtitle {
      color: rgba(255,255,255,0.6);
      text-align: center;
      margin-bottom: 28px;
      font-size: 0.9rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Score tab â€” two-column layout
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .layout {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .app {
      flex: 1;
      min-width: 0;
      position: relative;
    }

    .score-timer {
      position: absolute;
      top: 16px;
      right: 20px;
      font-size: 1.05rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.5px;
      color: rgba(255,255,255,0.5);
      min-width: 44px;
      text-align: right;
      transition: color 0.2s;
    }
    .score-timer.running { color: rgba(255,255,255,0.9); }
    .score-timer.stopped { color: rgba(255,255,255,0.4); }

    .streak-counter {
      position: absolute;
      top: 16px;
      left: 20px;
      font-size: 1.05rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.5px;
      user-select: none;
      transition: color 0.25s;
    }
    .streak-zero { color: rgba(255,255,255,0.25); }
    .streak-low  { color: rgba(255,255,255,0.75); }
    .streak-mid  { color: #f39c12; }
    .streak-high { color: #e67e22; }
    .streak-max  { color: #f1c40f; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Cards (shared)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .cards-area {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 16px;
      margin-bottom: 28px;
    }

    .hand-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .group-label {
      color: rgba(255,255,255,0.7);
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .cards-row { display: flex; gap: 8px; }

    .plus-sign {
      color: rgba(255,255,255,0.45);
      font-size: 1.8rem;
      margin-bottom: 8px;
      align-self: flex-end;
    }

    .card {
      width: 72px;
      height: 100px;
      display: block;
      filter: drop-shadow(2px 3px 8px rgba(0,0,0,0.4)) drop-shadow(0 0 1px rgba(0,0,0,0.1));
      user-select: none;
      flex-shrink: 0;
    }

    /* Face-down card back */
    .card-back {
      width: 72px;
      height: 100px;
      border-radius: 8px;
      background: #2855a0;
      box-shadow: 2px 3px 8px rgba(0,0,0,0.4);
      overflow: hidden;
    }
    .card-back-inner {
      width: 100%;
      height: 100%;
      background: repeating-linear-gradient(
        45deg,
        rgba(255,255,255,0.07),
        rgba(255,255,255,0.07) 4px,
        transparent 4px,
        transparent 10px
      );
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Score input
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .score-area {
      background: rgba(0,0,0,0.22);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .score-prompt {
      color: #fff;
      text-align: center;
      font-size: 1.05rem;
      margin-bottom: 14px;
    }

    .score-row {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    #score-input {
      width: 88px;
      padding: 10px;
      font-size: 1.3rem;
      border: 2px solid rgba(255,255,255,0.25);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      text-align: center;
      outline: none;
      transition: border-color 0.2s;
      -moz-appearance: textfield;
    }
    #score-input::-webkit-outer-spin-button,
    #score-input::-webkit-inner-spin-button { -webkit-appearance: none; }
    #score-input:focus { border-color: rgba(255,255,255,0.7); }
    #score-input::placeholder { color: rgba(255,255,255,0.3); }
    #score-input.error { border-color: #e74c3c; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Buttons (shared)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    button {
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: filter 0.15s, transform 0.1s;
    }
    button:hover  { filter: brightness(1.1); }
    button:active { filter: brightness(0.92); transform: translateY(1px); }
    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      filter: none;
      transform: none;
    }

    #check-btn { background: #e67e22; color: #fff; }

    #show-breakdown-btn {
      display: none;
      background: rgba(255,255,255,0.15);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.25);
      margin-top: 12px;
      font-size: 0.88rem;
    }

    #new-hand-btn, #crib-new-btn {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      background: var(--accent);
      color: #fff;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Score result
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #result-area {
      display: none;
      margin-bottom: 16px;
      text-align: center;
    }

    .result-box {
      border-radius: 10px;
      padding: 16px 20px;
      color: #fff;
    }
    .result-box.correct   { background: rgba(39,174,96,0.22);  border: 2px solid #2ecc71; }
    .result-box.incorrect { background: rgba(231,76,60,0.22);  border: 2px solid #e74c3c; }

    .result-icon { font-size: 1.6rem; margin-bottom: 4px; }
    .result-msg  { font-size: 1.15rem; font-weight: 600; }
    .result-sub  { font-size: 0.9rem; margin-top: 5px; opacity: 0.85; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Breakdown (shared style)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .breakdown-box {
      background: rgba(0,0,0,0.28);
      border-radius: 10px;
      padding: 18px 20px;
      margin-bottom: 16px;
      color: #fff;
    }

    #details-area { display: none; }
    #details-area.breakdown-box { margin-bottom: 16px; }

    .det-heading {
      color: var(--highlight);
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 14px;
    }

    .det-section { margin-bottom: 10px; }
    .det-header { font-weight: 600; font-size: 0.95rem; }
    .det-header.has  { color: var(--highlight); }
    .det-header.none { color: rgba(255,255,255,0.38); }

    .det-item {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.82);
      padding-left: 14px;
      margin-top: 3px;
      font-family: 'Courier New', monospace;
    }

    .det-hand-display {
      display: flex;
      align-items: center;
      gap: 3px;
      margin-bottom: 14px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
    }
    .det-hand-display .mini-card { width: 28px; height: 39px; }

    .det-total {
      border-top: 1px solid rgba(255,255,255,0.18);
      padding-top: 10px;
      margin-top: 8px;
      font-size: 1.1rem;
      font-weight: 700;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       History panel
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .hist-panel {
      width: 300px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .hist-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .hist-title { color: #fff; font-size: 1rem; font-weight: 700; }

    #reset-btn {
      padding: 5px 12px;
      font-size: 0.78rem;
      background: rgba(231,76,60,0.25);
      color: #e74c3c;
      border: 1px solid rgba(231,76,60,0.4);
      border-radius: 6px;
    }
    #reset-btn:hover { background: rgba(231,76,60,0.4); filter: none; }

    .stats-bar {
      background: rgba(0,0,0,0.22);
      border-radius: 10px;
      padding: 12px;
    }

    .stats-empty { color: rgba(255,255,255,0.4); font-size: 0.82rem; text-align: center; font-style: italic; }

    .stat-grid { display: flex; gap: 6px; }

    .stat {
      flex: 1;
      background: rgba(255,255,255,0.07);
      border-radius: 8px;
      padding: 8px 4px;
      text-align: center;
    }

    .stat-val { color: var(--highlight); font-size: 1.15rem; font-weight: 700; line-height: 1; }
    .stat-lbl { color: rgba(255,255,255,0.55); font-size: 0.68rem; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.8px; }

    .hist-list-wrap {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 520px;
      overflow-y: auto;
      padding-right: 2px;
    }
    .hist-list-wrap::-webkit-scrollbar { width: 4px; }
    .hist-list-wrap::-webkit-scrollbar-track { background: transparent; }
    .hist-list-wrap::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

    .hist-empty { color: rgba(255,255,255,0.35); font-size: 0.82rem; text-align: center; font-style: italic; padding: 16px 0; }

    .hist-entry {
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 8px 10px 8px;
      border-left: 3px solid transparent;
    }
    .hist-entry.ok  { border-left-color: #2ecc71; }
    .hist-entry.bad { border-left-color: #e74c3c; }

    .hist-cards { display: flex; align-items: center; flex-wrap: wrap; gap: 3px; margin-bottom: 5px; }
    .hist-cards .mini-card { width: 28px; height: 39px; }

    .chip {
      display: inline-block;
      font-size: 0.72rem;
      font-weight: 700;
      padding: 2px 5px;
      border-radius: 4px;
      background: rgba(255,255,255,0.1);
      font-family: 'Courier New', monospace;
      white-space: nowrap;
    }
    .chip.red { color: #e8614a; }
    .chip.blk { color: #d0e8d0; }

    .hist-sep { color: rgba(255,255,255,0.35); font-size: 0.75rem; padding: 0 1px; }

    .hist-info { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; }
    .hist-result { font-weight: 700; font-size: 0.85rem; }
    .hist-result.ok  { color: #2ecc71; }
    .hist-result.bad { color: #e74c3c; }
    .hist-scores { color: rgba(255,255,255,0.8); }
    .hist-time { margin-left: auto; color: rgba(255,255,255,0.45); font-size: 0.75rem; white-space: nowrap; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Crib tab â€” wrapper & panel
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .crib-wrapper {
      display: flex;
      justify-content: center;
    }

    .crib-app {
      max-width: 700px;
      width: 100%;
    }

    /* â”€â”€ Role mode toggle â”€â”€ */
    .role-toggle {
      display: flex;
      background: rgba(0,0,0,0.22);
      border-radius: 20px;
      padding: 3px;
      gap: 2px;
      width: fit-content;
      margin: 0 auto 20px;
    }

    .role-toggle-btn {
      padding: 6px 20px;
      font-size: 0.85rem;
      font-weight: 600;
      border: none;
      border-radius: 17px;
      cursor: pointer;
      color: rgba(255,255,255,0.5);
      background: transparent;
      transition: color 0.15s, background 0.15s;
    }
    .role-toggle-btn:hover:not(.active) { color: rgba(255,255,255,0.85); filter: none; transform: none; }
    .role-toggle-btn.active { color: #fff; background: rgba(255,255,255,0.15); }
    .role-toggle-btn:active { transform: none; filter: none; }

    /* â”€â”€ Role badge â”€â”€ */
    .role-area {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 22px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 12px 16px;
    }

    .role-badge {
      font-size: 0.85rem;
      font-weight: 700;
      padding: 5px 14px;
      border-radius: 20px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .role-badge.dealer { background: #d4a00a; color: #1a1a00; }
    .role-badge.pone   { background: #2471a3; color: #fff; }

    .role-tip { color: rgba(255,255,255,0.8); font-size: 0.85rem; line-height: 1.4; }

    /* â”€â”€ Crib 6-card selection area â”€â”€ */
    .crib-deal-section { margin-bottom: 14px; }

    .crib-cards-row {
      display: flex;
      gap: 10px;
      padding-top: 28px;       /* room for badges above cards */
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Card wrapper for interactive selection */
    .crib-card-wrap {
      position: relative;
      cursor: pointer;
      transition: transform 0.18s;
      display: inline-flex;
      border-radius: 9px;
    }
    .crib-card-wrap:hover:not(.selected) { transform: translateY(-5px); }
    .crib-card-wrap.selected { transform: translateY(-14px); box-shadow: 0 0 0 3px #e74c3c; }
    .crib-card-wrap.kept     { box-shadow: 0 0 0 3px #2ecc71; }
    .crib-card-wrap.evaluated       { cursor: default; }
    .crib-card-wrap.evaluated:hover { transform: none; }

    .card-badge {
      position: absolute;
      top: -22px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 4px;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      pointer-events: none;
    }
    .crib-badge { background: #e74c3c; color: #fff; }
    .keep-badge { background: #2ecc71; color: #1a1a1a; }

    .crib-status {
      text-align: center;
      margin: 10px 0 16px;
      font-size: 0.88rem;
      min-height: 1.2em;
      transition: color 0.2s;
    }

    /* â”€â”€ Crib submit button â”€â”€ */
    #crib-submit-btn {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      background: #e67e22;
      color: #fff;
      margin-bottom: 20px;
      transition: background 0.15s, filter 0.15s, transform 0.1s;
    }
    #crib-submit-btn:disabled { background: rgba(255,255,255,0.12); color: rgba(255,255,255,0.4); }

    /* â”€â”€ Crib results â”€â”€ */
    #crib-results { color: #fff; }

    .crib-result-cards {
      display: flex;
      align-items: flex-end;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .crib-divider {
      width: 1px;
      height: 60px;
      background: rgba(255,255,255,0.2);
      align-self: center;
      flex-shrink: 0;
    }

    /* â”€â”€ Crib stats summary row â”€â”€ */
    .crib-stats-row {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      gap: 14px;
      padding: 12px 16px;
      background: rgba(0,0,0,0.18);
      border-radius: 8px;
      margin-bottom: 18px;
    }

    .crib-stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .crib-stat-lbl {
      font-size: 0.63rem;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: rgba(255,255,255,0.4);
    }

    .crib-stat-val {
      font-size: 0.97rem;
      font-weight: 700;
      color: var(--highlight);
    }

    .crib-stat-sep {
      color: rgba(255,255,255,0.2);
      font-size: 1.1rem;
      align-self: center;
    }

    /* â”€â”€ Evaluation grade â”€â”€ */
    .eval-section {
      background: rgba(0,0,0,0.22);
      border-radius: 10px;
      padding: 16px 18px;
      margin-bottom: 16px;
    }

    .eval-section-title {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 10px;
    }

    .eval-grade {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .eval-grade.optimal   { background: rgba(39,174,96,0.25);  border: 2px solid #27ae60; color: #2ecc71; }
    .eval-grade.excellent { background: rgba(39,174,96,0.18);  border: 2px solid #27ae60; color: #2ecc71; }
    .eval-grade.good      { background: rgba(241,196,15,0.18); border: 2px solid #f1c40f; color: #f1c40f; }
    .eval-grade.fair      { background: rgba(230,126,34,0.18); border: 2px solid #e67e22; color: #e67e22; }
    .eval-grade.poor      { background: rgba(231,76,60,0.18);  border: 2px solid #e74c3c; color: #e74c3c; }

    .eval-rank-note  { font-size: 0.88rem; color: rgba(255,255,255,0.7); margin-bottom: 4px; }
    .eval-delta-note { font-size: 0.88rem; color: rgba(255,255,255,0.6); }

    /* â”€â”€ Crib analysis box â”€â”€ */
    .crib-analysis-row { font-size: 0.88rem; color: rgba(255,255,255,0.8); line-height: 1.6; }
    .crib-good { color: #2ecc71; font-weight: 600; }
    .crib-bad  { color: #e74c3c; font-weight: 600; }
    .crib-ok   { color: #f1c40f; font-weight: 600; }

    /* â”€â”€ All-15 ranking table â”€â”€ */
    .rank-table-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 2px;
    }
    .rank-table-wrap::-webkit-scrollbar { width: 4px; }
    .rank-table-wrap::-webkit-scrollbar-track { background: transparent; }
    .rank-table-wrap::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

    .rank-row {
      display: flex;
      flex-direction: column;
      gap: 3px;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 0.82rem;
    }
    .rank-row.you-row {
      background: rgba(243,156,18,0.18);
      border: 1px solid rgba(243,156,18,0.4);
    }

    .rank-num {
      width: 24px;
      color: rgba(255,255,255,0.45);
      font-size: 0.75rem;
      flex-shrink: 0;
    }

    .rank-sep {
      color: rgba(255,255,255,0.25);
      flex-shrink: 0;
      font-size: 0.8rem;
    }

    .rank-score {
      font-weight: 700;
      color: #fff;
      min-width: 38px;
      text-align: right;
      flex-shrink: 0;
    }

    /* â”€â”€ Two-line rank row â”€â”€ */
    .rank-row-top {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
    }
    .rank-cards-group {
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 1;
      min-width: 0;
    }
    .rank-mini-hand, .rank-mini-discard {
      display: flex;
      gap: 2px;
      flex-shrink: 0;
    }
    .mini-card {
      display: block;
      flex-shrink: 0;
      filter: drop-shadow(1px 2px 4px rgba(0,0,0,0.35));
      user-select: none;
    }
    .rank-row-stats {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-left: 30px;
    }
    .rank-stat-item {
      display: flex;
      align-items: baseline;
      gap: 3px;
    }
    .rank-stat-lbl {
      font-size: 0.68rem;
      color: rgba(255,255,255,0.4);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .rank-stat-val {
      font-size: 0.8rem;
      font-weight: 600;
      color: rgba(255,255,255,0.75);
      font-variant-numeric: tabular-nums;
    }
    .rank-avg-val { color: var(--highlight); }
    .rank-crib-val { color: rgba(255,255,255,0.5); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Timed Challenge
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .challenge-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0,0,0,0.28);
      border-radius: 10px;
      padding: 10px 16px;
      margin-bottom: 18px;
    }
    .challenge-countdown-wrap { display: flex; align-items: baseline; gap: 6px; }
    .challenge-countdown {
      font-size: 1.4rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      color: #fff;
    }
    .challenge-countdown.urgent { color: #e74c3c; }
    .challenge-clock-label { font-size: 0.78rem; color: rgba(255,255,255,0.5); }
    .challenge-score-display { font-size: 0.9rem; font-weight: 700; color: var(--highlight); }

    #start-challenge-btn {
      width: 100%;
      padding: 10px;
      font-size: 0.88rem;
      margin-top: 8px;
      background: transparent;
      color: rgba(255,255,255,0.6);
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 8px;
    }
    #start-challenge-btn:hover { color: #fff; border-color: rgba(255,255,255,0.5); filter: none; }

    .challenge-results-inner {
      background: rgba(0,0,0,0.28);
      border-radius: 12px;
      padding: 24px 20px;
      text-align: center;
      color: #fff;
      margin-bottom: 16px;
    }
    .challenge-results-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 6px; }
    .challenge-results-sub   { font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-bottom: 20px; }
    .challenge-stat-grid     { display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; }
    .challenge-stat {
      flex: 1;
      background: rgba(255,255,255,0.07);
      border-radius: 10px;
      padding: 12px 6px;
      text-align: center;
    }
    .challenge-stat-val {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--highlight);
      line-height: 1;
    }
    .challenge-stat-lbl {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: rgba(255,255,255,0.5);
      margin-top: 5px;
    }
    .challenge-btn-row { display: flex; gap: 8px; }
    #challenge-retry-btn { flex: 1; background: var(--accent); color: #fff; }
    #challenge-back-btn  {
      flex: 1;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.8);
      border: 1px solid rgba(255,255,255,0.2);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Settings button
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .settings-btn {
      margin-left: auto;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0,0,0,0.28);
      color: rgba(255,255,255,0.55);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      padding: 0;
      flex-shrink: 0;
      transition: color 0.15s, background 0.15s;
    }
    .settings-btn:hover  { color: #fff; background: rgba(0,0,0,0.45); filter: none; transform: none; }
    .settings-btn:active { transform: translateY(1px); filter: none; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Settings modal
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .settings-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    .settings-overlay.open { display: flex; }

    .settings-modal {
      background: var(--panel);
      border-radius: 16px;
      padding: 24px 26px;
      width: min(360px, 90vw);
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      animation: modal-in 0.18s ease;
    }
    @keyframes modal-in {
      from { transform: scale(0.92); opacity: 0; }
      to   { transform: scale(1);    opacity: 1; }
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 22px;
    }
    .settings-title { color: #fff; font-size: 1.1rem; font-weight: 700; }

    .settings-close {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.65);
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 1;
      transition: background 0.15s, color 0.15s;
    }
    .settings-close:hover  { background: rgba(255,255,255,0.22); color: #fff; filter: none; transform: none; }
    .settings-close:active { transform: none; filter: none; }

    .setting-group { margin-bottom: 4px; }
    .setting-group-label {
      color: rgba(255,255,255,0.45);
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      margin-bottom: 12px;
    }

    .theme-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    .theme-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(0,0,0,0.22);
      border: 2px solid transparent;
      cursor: pointer;
      transition: border-color 0.15s;
      text-align: left;
      width: 100%;
      color: #fff;
    }
    .theme-option:hover:not(.active) { border-color: rgba(255,255,255,0.2); filter: none; transform: none; }
    .theme-option.active  { border-color: rgba(255,255,255,0.6); }
    .theme-option:active  { transform: none; filter: none; }

    .theme-swatch {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      flex-shrink: 0;
      box-shadow: 0 1px 4px rgba(0,0,0,0.4);
    }
    .theme-name { font-size: 0.84rem; font-weight: 600; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Responsive
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width: 880px) {
      .layout      { flex-direction: column; }
      .app         { width: 100%; }
      .hist-panel  { width: 100%; }
      .hist-list-wrap { max-height: 300px; }
    }

    @media (max-width: 520px) {
      body         { padding: 12px 8px; }
      .panel-box   { padding: 20px 14px; }
      h1           { font-size: 1.55rem; }
      .card        { width: 60px; height: 84px; }
      .card-back   { width: 60px; height: 84px; }
      .crib-cards-row { gap: 7px; }
    }

    @media (max-width: 420px) {
      body       { padding: 8px 6px; }
      .panel-box { padding: 16px 10px; }

      /* Smaller cards â€” 5 in score row + 3Ã—2 crib grid fit comfortably */
      .card      { width: 54px; height: 75px; }
      .card-back { width: 54px; height: 75px; }

      /* Tighter gaps for score practice card layout */
      .cards-area { gap: 6px; }
      .cards-row  { gap: 4px; }
      .plus-sign  { font-size: 1.2rem; }

      /* 6 crib cards â†’ 3Ã—2 grid instead of single overflowing row */
      .crib-cards-row {
        display: grid;
        grid-template-columns: repeat(3, auto);
        gap: 10px;
        padding-top: 28px;
        justify-content: center;
      }

      /* Stack hand + discards vertically in results view; hide divider */
      .crib-result-cards { flex-direction: column; align-items: flex-start; gap: 8px; }
      .crib-divider      { display: none; }

      /* Reduce section/stats padding */
      .eval-section   { padding: 12px 10px; }
      .crib-stats-row { gap: 8px; padding: 10px 8px; }
      .tab-btn        { padding: 8px 14px; font-size: 0.88rem; }
    }
  </style>
</head>
<body>

<div class="page-root">

  <!-- â•â• Tab bar â•â• -->
  <div class="tab-bar">
    <button class="tab-btn active" id="tab-score-btn">ğŸƒ Score Practice</button>
    <button class="tab-btn"        id="tab-crib-btn" >ğŸ´ Crib Discard</button>
    <button class="settings-btn"   id="settings-btn"  title="Settings">âš™</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCORE PRACTICE TAB
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="panel-score">
    <div class="layout">

      <!-- Game panel -->
      <div class="app panel-box">
        <div class="streak-counter streak-zero" id="streak-counter">ğŸ”¥ 0</div>
        <div class="score-timer" id="score-timer">0.0s</div>
        <h1>Score Practice</h1>
        <p class="subtitle">Practice scoring your cribbage hand</p>

        <div class="role-toggle" id="diff-toggle">
          <button class="role-toggle-btn active" data-min="0">Any</button>
          <button class="role-toggle-btn"        data-min="6">6+</button>
          <button class="role-toggle-btn"        data-min="10">10+</button>
        </div>

        <div id="challenge-bar" class="challenge-bar" style="display:none">
          <div class="challenge-countdown-wrap">
            <span>â±</span>
            <span id="challenge-countdown" class="challenge-countdown">60.0s</span>
            <span class="challenge-clock-label">remaining</span>
          </div>
          <div id="challenge-score-display" class="challenge-score-display">0 correct</div>
        </div>

        <div class="cards-area" id="cards-area"></div>

        <div class="score-area">
          <div class="score-prompt">What is the score of this hand?</div>
          <div class="score-row">
            <input type="number" id="score-input" placeholder="0" min="0" max="29">
            <button id="check-btn">Check Score</button>
          </div>
        </div>

        <div id="result-area">
          <div class="result-box" id="result-box">
            <div class="result-icon" id="result-icon"></div>
            <div class="result-msg"  id="result-msg"></div>
            <div class="result-sub"  id="result-sub"></div>
          </div>
          <button id="show-breakdown-btn">Show Breakdown</button>
        </div>

        <div id="details-area"></div>

        <div id="challenge-results" style="display:none"></div>

        <button id="new-hand-btn">Deal New Hand</button>
        <button id="start-challenge-btn">âš¡ 60s Challenge</button>
      </div>

      <!-- History panel -->
      <div class="hist-panel panel-box">
        <div class="hist-header">
          <span class="hist-title">Session History</span>
          <button id="reset-btn">Reset</button>
        </div>
        <div class="stats-bar"      id="stats-bar"></div>
        <div class="hist-list-wrap" id="hist-list"></div>
      </div>

    </div>
  </div><!-- #panel-score -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CRIB DISCARD TAB
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="panel-crib" style="display:none">
    <div class="crib-wrapper">
      <div class="crib-app panel-box">

        <h1>Crib Discard</h1>
        <p class="subtitle">Choose which 2 cards to send to the crib</p>

        <!-- Role mode toggle -->
        <div class="role-toggle">
          <button class="role-toggle-btn" data-mode="pone"   onclick="setCribRoleMode('pone')">Pone</button>
          <button class="role-toggle-btn active" data-mode="random" onclick="setCribRoleMode('random')">Random</button>
          <button class="role-toggle-btn" data-mode="dealer" onclick="setCribRoleMode('dealer')">Dealer</button>
        </div>

        <!-- Role badge -->
        <div id="crib-role-area"></div>

        <!-- 6 dealt cards (hidden after evaluation) -->
        <div id="crib-deal-section">
          <div class="crib-deal-section">
            <div class="group-label" style="text-align:center; margin-bottom:4px;">Your 6 Cards</div>
            <div class="crib-cards-row" id="crib-cards-row"></div>
          </div>
          <div class="crib-status" id="crib-status"></div>
          <button id="crib-submit-btn" disabled>Select 2 cards to discard (0/2)</button>
        </div>

        <!-- Results (revealed after submit) -->
        <div id="crib-results" style="display:none"></div>

        <!-- Deal new hand -->
        <button id="crib-new-btn" style="display:none">Deal New Hand</button>

      </div>
    </div>
  </div><!-- #panel-crib -->

</div><!-- .page-root -->

<!-- â•â• Settings modal â•â• -->
<div id="settings-overlay" class="settings-overlay">
  <div class="settings-modal">
    <div class="settings-header">
      <span class="settings-title">âš™ Settings</span>
      <button class="settings-close" id="settings-close" aria-label="Close">âœ•</button>
    </div>
    <div class="setting-group">
      <div class="setting-group-label">Theme</div>
      <div class="theme-options" id="theme-options"></div>
    </div>
  </div>
</div>

<script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  Shared constants & helpers
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  const SUITS = ['â™ ','â™¥','â™¦','â™£'];
  const RED   = new Set(['â™¥','â™¦']);
  const SUIT_NAMES = {'â™ ':'Spades','â™¥':'Hearts','â™¦':'Diamonds','â™£':'Clubs'};
  const STORAGE_KEY = 'cribbage-history';

  function cardVal(rank) {
    if (rank === 'A') return 1;
    if (rank === 'J' || rank === 'Q' || rank === 'K') return 10;
    return parseInt(rank, 10);
  }

  function rankIdx(rank) { return RANKS.indexOf(rank); }
  function lbl(c) { return c.rank + c.suit; }

  function createDeck() {
    return RANKS.flatMap(r => SUITS.map(s => ({ rank: r, suit: s })));
  }

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function combos(arr, k) {
    if (k === 0) return [[]];
    if (arr.length < k) return [];
    const [head, ...tail] = arr;
    return [
      ...combos(tail, k - 1).map(c => [head, ...c]),
      ...combos(tail, k)
    ];
  }

  function cardHTML(c) {
    const color = RED.has(c.suit) ? '#c0392b' : '#1a1a2e';
    const r = c.rank;
    const s = c.suit;
    return `<svg class="card" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 100" width="72" height="100">
      <rect x="0.5" y="0.5" width="71" height="99" rx="7.5" ry="7.5" fill="white"/>
      <rect x="0.5" y="0.5" width="71" height="99" rx="7.5" ry="7.5" fill="none" stroke="rgba(0,0,0,0.12)" stroke-width="1"/>
      <text x="5" y="15" font-family="'Segoe UI',system-ui,sans-serif" font-size="13" font-weight="700" fill="${color}">${r}</text>
      <text x="5" y="28" font-family="Arial,sans-serif" font-size="12" fill="${color}">${s}</text>
      <text x="36" y="50" font-family="Arial,sans-serif" font-size="30" text-anchor="middle" dominant-baseline="central" fill="${color}">${s}</text>
      <g transform="rotate(180,36,50)">
        <text x="5" y="15" font-family="'Segoe UI',system-ui,sans-serif" font-size="13" font-weight="700" fill="${color}">${r}</text>
        <text x="5" y="28" font-family="Arial,sans-serif" font-size="12" fill="${color}">${s}</text>
      </g>
    </svg>`;
  }

  function chipHTML(c) {
    return `<span class="chip ${RED.has(c.suit) ? 'red' : 'blk'}">${c.rank}${c.suit}</span>`;
  }

  function miniCardHTML(c) {
    const color = RED.has(c.suit) ? '#c0392b' : '#1a1a2e';
    return `<svg class="mini-card" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 100" width="34" height="47">
      <rect x="0.5" y="0.5" width="71" height="99" rx="7.5" ry="7.5" fill="white"/>
      <rect x="0.5" y="0.5" width="71" height="99" rx="7.5" ry="7.5" fill="none" stroke="rgba(0,0,0,0.12)" stroke-width="1"/>
      <text x="36" y="40" font-family="'Segoe UI',system-ui,sans-serif" font-size="30" font-weight="700" text-anchor="middle" dominant-baseline="central" fill="${color}">${c.rank}</text>
      <text x="36" y="72" font-family="Arial,sans-serif" font-size="26" text-anchor="middle" dominant-baseline="central" fill="${color}">${c.suit}</text>
    </svg>`;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  Shared scoring engine
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function scoreHand(h, s) {
    const all = [...h, s];
    let total = 0;
    const secs = [];

    // Fifteens
    const fCombos = [];
    for (let k = 2; k <= 5; k++) {
      for (const combo of combos(all, k)) {
        if (combo.reduce((sum, c) => sum + cardVal(c.rank), 0) === 15) {
          fCombos.push(combo.map(lbl).join(' + '));
        }
      }
    }
    const fPts = fCombos.length * 2;
    total += fPts;
    secs.push({
      label:  fCombos.length ? `Fifteens â€” ${fCombos.length} Ã— 2 = ${fPts} pts` : 'Fifteens â€” 0 pts',
      haspts: fCombos.length > 0,
      items:  fCombos.map(f => f + ' = 15')
    });

    // Pairs
    const pairList = [];
    for (const [a, b] of combos(all, 2)) {
      if (a.rank === b.rank) pairList.push(`${lbl(a)} + ${lbl(b)}`);
    }
    const pPts = pairList.length * 2;
    total += pPts;
    secs.push({
      label:  pairList.length ? `Pairs â€” ${pairList.length} Ã— 2 = ${pPts} pts` : 'Pairs â€” 0 pts',
      haspts: pairList.length > 0,
      items:  pairList
    });

    // Runs
    const rc = {};
    for (const c of all) { const i = rankIdx(c.rank); rc[i] = (rc[i] || 0) + 1; }
    const sortedR = Object.keys(rc).map(Number).sort((a, b) => a - b);
    let runTotal = 0;
    const runItems = [];
    let i = 0;
    while (i < sortedR.length) {
      let j = i;
      while (j + 1 < sortedR.length && sortedR[j + 1] === sortedR[j] + 1) j++;
      const len = j - i + 1;
      if (len >= 3) {
        let mult = 1;
        for (let k = i; k <= j; k++) mult *= rc[sortedR[k]];
        const pts = len * mult;
        runTotal += pts;
        const rlabels = sortedR.slice(i, j + 1).map(x => RANKS[x]).join('-');
        runItems.push(mult > 1
          ? `${mult} runs of ${len} (${rlabels}) = ${pts} pts`
          : `Run of ${len} (${rlabels}) = ${pts} pts`);
      }
      i = j + 1;
    }
    total += runTotal;
    secs.push({
      label:  runTotal ? `Runs â€” ${runTotal} pts` : 'Runs â€” 0 pts',
      haspts: runTotal > 0,
      items:  runItems
    });

    // Flush
    const hSuits = h.map(c => c.suit);
    let flushPts = 0, flushNote = null;
    if (hSuits.every(x => x === hSuits[0])) {
      if (s.suit === hSuits[0]) {
        flushPts = 5;
        flushNote = `All 5 cards are ${SUIT_NAMES[hSuits[0]]}`;
      } else {
        flushPts = 4;
        flushNote = `4 hand cards are ${SUIT_NAMES[hSuits[0]]} (starter is ${SUIT_NAMES[s.suit]})`;
      }
    }
    total += flushPts;
    secs.push({
      label:  flushPts ? `Flush â€” ${flushPts} pts` : 'Flush â€” 0 pts',
      haspts: flushPts > 0,
      items:  flushNote ? [flushNote] : []
    });

    // His Nobs
    let nobsPts = 0, nobsNote = null;
    for (const c of h) {
      if (c.rank === 'J' && c.suit === s.suit) {
        nobsPts = 1;
        nobsNote = `J${c.suit} in hand matches starter suit (${SUIT_NAMES[c.suit]})`;
        break;
      }
    }
    total += nobsPts;
    secs.push({
      label:  nobsPts ? 'His Nobs â€” 1 pt' : 'His Nobs â€” 0 pts',
      haspts: nobsPts > 0,
      items:  nobsNote ? [nobsNote] : []
    });

    return { total, secs };
  }

  // Partial crib score: just the 2 discarded cards + starter (no flush)
  function scorePartialCrib(cards, starter) {
    const all = [...cards, starter];
    let total = 0;

    for (let k = 2; k <= all.length; k++) {
      for (const combo of combos(all, k)) {
        if (combo.reduce((s, c) => s + cardVal(c.rank), 0) === 15) total += 2;
      }
    }

    for (const [a, b] of combos(all, 2)) {
      if (a.rank === b.rank) total += 2;
    }

    const rc = {};
    for (const c of all) { const i = rankIdx(c.rank); rc[i] = (rc[i] || 0) + 1; }
    const sr = Object.keys(rc).map(Number).sort((a, b) => a - b);
    let idx = 0;
    while (idx < sr.length) {
      let j = idx;
      while (j + 1 < sr.length && sr[j + 1] === sr[j] + 1) j++;
      const len = j - idx + 1;
      if (len >= 3) {
        let mult = 1;
        for (let k = idx; k <= j; k++) mult *= rc[sr[k]];
        total += len * mult;
      }
      idx = j + 1;
    }

    for (const c of cards) {
      if (c.rank === 'J' && c.suit === starter.suit) { total += 1; break; }
    }

    return total;
  }

  // Fast full-crib scorer: your 2 discards + opponent's 2 discards + cut (5 cards)
  // Uses bitmask iteration for fifteens â€” no combos() calls, no heap allocation
  // Crib flush rule: only 5-card flush counts (no 4-card flush in crib)
  function scoreCrib5Fast(d1, d2, o1, o2, cut) {
    const v0 = cardVal(d1.rank),  v1 = cardVal(d2.rank),
          v2 = cardVal(o1.rank),  v3 = cardVal(o2.rank),
          v4 = cardVal(cut.rank);
    const r0 = rankIdx(d1.rank),  r1 = rankIdx(d2.rank),
          r2 = rankIdx(o1.rank),  r3 = rankIdx(o2.rank),
          r4 = rankIdx(cut.rank);
    let score = 0;

    // Fifteens: bitmask over all 31 non-empty subsets, skip size-1
    for (let mask = 1; mask < 32; mask++) {
      if ((mask & (mask - 1)) === 0) continue; // single-bit = size 1, skip
      let sum = 0;
      if (mask &  1) sum += v0;
      if (mask &  2) sum += v1;
      if (mask &  4) sum += v2;
      if (mask &  8) sum += v3;
      if (mask & 16) sum += v4;
      if (sum === 15) score += 2;
    }

    // Pairs
    const r = [r0, r1, r2, r3, r4];
    for (let i = 0; i < 5; i++)
      for (let j = i + 1; j < 5; j++)
        if (r[i] === r[j]) score += 2;

    // Runs: rank-count then scan for consecutive sequences
    const cnt = [0,0,0,0,0,0,0,0,0,0,0,0,0];
    cnt[r0]++; cnt[r1]++; cnt[r2]++; cnt[r3]++; cnt[r4]++;
    let i = 0;
    while (i < 13) {
      if (cnt[i] === 0) { i++; continue; }
      let j = i;
      while (j < 12 && cnt[j + 1] > 0) j++;
      const len = j - i + 1;
      if (len >= 3) {
        let mult = 1;
        for (let k = i; k <= j; k++) mult *= cnt[k];
        score += len * mult;
      }
      i = j + 1;
    }

    // Flush: crib requires ALL 5 cards same suit
    if (d1.suit === d2.suit && d2.suit === o1.suit &&
        o1.suit === o2.suit && o2.suit === cut.suit) score += 5;

    // His Nobs: jack among the 4 crib cards matching cut suit
    const cs = cut.suit;
    if      (d1.rank === 'J' && d1.suit === cs) score += 1;
    else if (d2.rank === 'J' && d2.suit === cs) score += 1;
    else if (o1.rank === 'J' && o1.suit === cs) score += 1;
    else if (o2.rank === 'J' && o2.suit === cs) score += 1;

    return score;
  }

  function buildBreakdownHTML(secs, totalPts) {
    const handCards    = hand.map(miniCardHTML).join('');
    const starterCard  = miniCardHTML(starter);
    let html = '<div class="det-heading">Score Breakdown</div>';
    html += `<div class="det-hand-display">${handCards}<span class="hist-sep">+</span>${starterCard}</div>`;
    for (const sec of secs) {
      html += `<div class="det-section">`;
      html += `<div class="det-header ${sec.haspts ? 'has' : 'none'}">${sec.label}</div>`;
      for (const item of sec.items) html += `<div class="det-item">â€¢ ${item}</div>`;
      html += `</div>`;
    }
    html += `<div class="det-total">Total: ${totalPts} pts</div>`;
    return html;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SETTINGS & THEMES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const THEMES = {
    green:    { name: 'Green Felt',    swatch: ['#145227','#27ae60'], vars: { '--bg':'#145227', '--panel':'#1a6b34', '--accent':'#27ae60', '--highlight':'#f1c40f' } },
    blue:     { name: 'Midnight Blue', swatch: ['#0d1b2a','#2980b9'], vars: { '--bg':'#0d1b2a', '--panel':'#16304a', '--accent':'#2980b9', '--highlight':'#5dade2' } },
    purple:   { name: 'Deep Purple',   swatch: ['#1a0d2e','#9b59b6'], vars: { '--bg':'#1a0d2e', '--panel':'#2d1b4e', '--accent':'#9b59b6', '--highlight':'#d7bde2' } },
    charcoal: { name: 'Charcoal',      swatch: ['#1a1a1a','#4a90d9'], vars: { '--bg':'#1a1a1a', '--panel':'#2d2d2d', '--accent':'#4a90d9', '--highlight':'#f0c050' } }
  };

  let currentTheme = localStorage.getItem('crib-theme') || 'green';

  function applyTheme(key) {
    currentTheme = key;
    const vars = THEMES[key].vars;
    for (const [k, v] of Object.entries(vars))
      document.documentElement.style.setProperty(k, v);
    localStorage.setItem('crib-theme', key);
    // Keep browser chrome / status bar in sync with theme background
    document.querySelector('meta[name="theme-color"]').setAttribute('content', vars['--bg']);
    renderThemeOptions();
  }

  function renderThemeOptions() {
    const el = document.getElementById('theme-options');
    if (!el) return;
    el.innerHTML = Object.entries(THEMES).map(([key, th]) => `
      <button class="theme-option ${key === currentTheme ? 'active' : ''}" onclick="applyTheme('${key}')">
        <div class="theme-swatch" style="background:linear-gradient(135deg,${th.swatch[0]} 50%,${th.swatch[1]} 50%)"></div>
        <span class="theme-name">${th.name}</span>
      </button>
    `).join('');
  }

  // Settings modal open / close
  document.getElementById('settings-btn').addEventListener('click', () => {
    document.getElementById('settings-overlay').classList.add('open');
    renderThemeOptions();
  });
  document.getElementById('settings-close').addEventListener('click', () => {
    document.getElementById('settings-overlay').classList.remove('open');
  });
  document.getElementById('settings-overlay').addEventListener('click', e => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  TAB SWITCHING
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let activeTab = 'score';

  function switchTab(tab) {
    if (challengeActive) abandonChallenge();
    activeTab = tab;
    localStorage.setItem('crib-active-tab', tab);
    document.getElementById('panel-score').style.display = tab === 'score' ? '' : 'none';
    document.getElementById('panel-crib').style.display  = tab === 'crib'  ? '' : 'none';
    document.getElementById('tab-score-btn').classList.toggle('active', tab === 'score');
    document.getElementById('tab-crib-btn').classList.toggle('active',  tab === 'crib');
    if (tab === 'crib' && crib6.length === 0) dealCribPractice();
    if (tab === 'score') deal();
  }

  document.getElementById('tab-score-btn').addEventListener('click', () => switchTab('score'));
  document.getElementById('tab-crib-btn').addEventListener('click',  () => switchTab('crib'));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SCORE PRACTICE TAB
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let hand = [], starter = null, answer = 0, sections = [], detailsOpen = false;
  let history = [];
  let dealTime = null, handScored = false;
  let timerInterval = null;

  // Difficulty filter
  let minScore = parseInt(localStorage.getItem('crib-min-score') || '0', 10);

  // Challenge mode state
  let challengeActive      = false;
  let challengeEndTime     = null;
  let challengeCountdownId = null;
  let challengeHands       = [];

  // Streak state
  let currentStreak = 0;

  function renderStreak() {
    const el = document.getElementById('streak-counter');
    el.textContent = `ğŸ”¥ ${currentStreak}`;
    el.className = 'streak-counter ' + (
      currentStreak === 0 ? 'streak-zero' :
      currentStreak <  3  ? 'streak-low'  :
      currentStreak <  5  ? 'streak-mid'  :
      currentStreak < 10  ? 'streak-high' : 'streak-max'
    );
  }

  function updateStreak(correct) {
    currentStreak = correct ? currentStreak + 1 : 0;
    renderStreak();
  }

  function startTimer() {
    clearInterval(timerInterval);
    const el = document.getElementById('score-timer');
    el.className = 'score-timer running';
    el.textContent = '0.0s';
    timerInterval = setInterval(() => {
      el.textContent = ((Date.now() - dealTime) / 1000).toFixed(1) + 's';
    }, 100);
  }

  function stopTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
    document.getElementById('score-timer').className = 'score-timer stopped';
  }

  // â”€â”€ Challenge mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startChallenge() {
    challengeActive  = true;
    challengeEndTime = Date.now() + 60000;
    challengeHands   = [];

    document.getElementById('challenge-bar').style.display        = '';
    document.getElementById('challenge-results').style.display    = 'none';
    document.getElementById('start-challenge-btn').style.display  = 'none';
    document.getElementById('new-hand-btn').style.display         = 'none';
    document.getElementById('result-area').style.display          = 'none';
    document.getElementById('details-area').style.display         = 'none';
    document.getElementById('show-breakdown-btn').style.display   = 'none';
    document.getElementById('challenge-score-display').textContent = '0 correct';

    challengeCountdownId = setInterval(() => {
      const rem = challengeEndTime - Date.now();
      if (rem <= 0) { endChallenge(); return; }
      const el = document.getElementById('challenge-countdown');
      el.textContent = (rem / 1000).toFixed(1) + 's';
      el.className = 'challenge-countdown' + (rem < 10000 ? ' urgent' : '');
    }, 100);

    deal();
  }

  function endChallenge() {
    clearInterval(challengeCountdownId);
    challengeCountdownId = null;
    challengeActive = false;
    stopTimer();

    document.getElementById('challenge-bar').style.display       = 'none';
    document.getElementById('cards-area').style.display          = 'none';
    document.querySelector('.score-area').style.display          = 'none';
    document.getElementById('result-area').style.display         = 'none';
    document.getElementById('details-area').style.display        = 'none';
    document.getElementById('show-breakdown-btn').style.display  = 'none';

    renderChallengeResults();
  }

  function renderChallengeResults() {
    const total   = challengeHands.length;
    const correct = challengeHands.filter(h => h.correct).length;
    const pct     = total > 0 ? Math.round(correct / total * 100) : 0;
    const avgMs   = total > 0 ? challengeHands.reduce((s, h) => s + h.timeMs, 0) / total : 0;

    const el = document.getElementById('challenge-results');
    el.style.display = '';
    el.innerHTML = `
      <div class="challenge-results-inner">
        <div class="challenge-results-title">âš¡ Challenge Complete!</div>
        <div class="challenge-results-sub">60 seconds Â· ${total} hand${total !== 1 ? 's' : ''} attempted</div>
        <div class="challenge-stat-grid">
          <div class="challenge-stat">
            <div class="challenge-stat-val">${correct}</div>
            <div class="challenge-stat-lbl">Correct</div>
          </div>
          <div class="challenge-stat">
            <div class="challenge-stat-val">${pct}%</div>
            <div class="challenge-stat-lbl">Accuracy</div>
          </div>
          <div class="challenge-stat">
            <div class="challenge-stat-val">${total > 0 ? fmtTime(avgMs) : 'â€”'}</div>
            <div class="challenge-stat-lbl">Avg Time</div>
          </div>
        </div>
        <div class="challenge-btn-row">
          <button id="challenge-retry-btn">âš¡ Try Again</button>
          <button id="challenge-back-btn">Back to Practice</button>
        </div>
      </div>`;

    document.getElementById('challenge-retry-btn').addEventListener('click', () => {
      restoreNormalGameUI(); startChallenge();
    });
    document.getElementById('challenge-back-btn').addEventListener('click', () => {
      restoreNormalGameUI(); deal();
    });
  }

  function restoreNormalGameUI() {
    document.getElementById('cards-area').style.display          = '';
    document.querySelector('.score-area').style.display          = '';
    document.getElementById('new-hand-btn').style.display        = '';
    document.getElementById('start-challenge-btn').style.display = '';
    document.getElementById('challenge-results').style.display   = 'none';
  }

  function abandonChallenge() {
    clearInterval(challengeCountdownId);
    challengeCountdownId = null;
    challengeActive = false;
    stopTimer();
    document.getElementById('challenge-bar').style.display = 'none';
    restoreNormalGameUI();
  }

  function loadHistory() {
    try { history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
    catch { history = []; }
  }

  function saveHistory() { localStorage.setItem(STORAGE_KEY, JSON.stringify(history)); }

  function fmtTime(ms) { return (ms / 1000).toFixed(1) + 's'; }

  function renderStats() {
    const el = document.getElementById('stats-bar');
    if (history.length === 0) { el.innerHTML = '<div class="stats-empty">No hands recorded yet.</div>'; return; }
    const correct = history.filter(r => r.userScore === r.actualScore).length;
    const pct     = Math.round(correct / history.length * 100);
    const avgMs   = history.reduce((s, r) => s + r.timeMs, 0) / history.length;
    el.innerHTML = `<div class="stat-grid">
      <div class="stat"><div class="stat-val">${pct}%</div><div class="stat-lbl">Correct</div></div>
      <div class="stat"><div class="stat-val">${correct}/${history.length}</div><div class="stat-lbl">Hands</div></div>
      <div class="stat"><div class="stat-val">${fmtTime(avgMs)}</div><div class="stat-lbl">Avg Time</div></div>
    </div>`;
  }

  function renderHistoryList() {
    const el = document.getElementById('hist-list');
    if (history.length === 0) { el.innerHTML = '<div class="hist-empty">Hand history will appear here.</div>'; return; }
    el.innerHTML = history.map(r => {
      const ok   = r.userScore === r.actualScore;
      const note = ok ? `Score: ${r.actualScore}` : `You: ${r.userScore} Â· Actual: ${r.actualScore}`;
      return `<div class="hist-entry ${ok ? 'ok' : 'bad'}">
        <div class="hist-cards">${r.hand.map(miniCardHTML).join('')}<span class="hist-sep">+</span>${miniCardHTML(r.starter)}</div>
        <div class="hist-info">
          <span class="hist-result ${ok ? 'ok' : 'bad'}">${ok ? 'âœ“' : 'âœ—'}</span>
          <span class="hist-scores">${note}</span>
          <span class="hist-time">${fmtTime(r.timeMs)}</span>
        </div>
      </div>`;
    }).join('');
  }

  function renderHistory() { renderStats(); renderHistoryList(); }

  function addRecord(rec) { history.unshift(rec); saveHistory(); renderHistory(); }

  function resetHistory() {
    if (!confirm('Reset all history and stats?')) return;
    history = [];
    localStorage.removeItem(STORAGE_KEY);
    renderHistory();
    currentStreak = 0;
    renderStreak();
  }

  function setDifficulty(min) {
    minScore = min;
    localStorage.setItem('crib-min-score', String(min));
    document.querySelectorAll('#diff-toggle .role-toggle-btn').forEach(btn => {
      btn.classList.toggle('active', +btn.dataset.min === min);
    });
    deal();
  }

  function scoreRenderCards() {
    document.getElementById('cards-area').innerHTML = `
      <div class="hand-group">
        <div class="group-label">Hand</div>
        <div class="cards-row">${hand.map(cardHTML).join('')}</div>
      </div>
      <div class="plus-sign">+</div>
      <div class="hand-group">
        <div class="group-label">Starter</div>
        <div class="cards-row">${cardHTML(starter)}</div>
      </div>`;
  }

  function deal() {
    let deck, h, s, r, attempts = 0;
    do {
      deck = shuffle(createDeck());
      h = deck.slice(0, 4);
      s = deck[4];
      r = scoreHand(h, s);
      attempts++;
    } while (r.total < minScore && attempts < 200);
    hand    = h;
    starter = s;
    answer   = r.total;
    sections = r.secs;
    detailsOpen = false;
    dealTime    = Date.now();
    handScored  = false;
    startTimer();

    scoreRenderCards();
    document.getElementById('score-input').value = '';
    document.getElementById('result-area').style.display = 'none';
    document.getElementById('details-area').style.display = 'none';
    document.getElementById('details-area').className = '';
    document.getElementById('show-breakdown-btn').style.display = 'none';
    document.getElementById('show-breakdown-btn').textContent = 'Show Breakdown';
    document.getElementById('score-input').classList.remove('error');
    document.getElementById('score-input').focus();
  }

  function checkScore() {
    const inp = document.getElementById('score-input');
    if (inp.value === '') {
      inp.classList.add('error');
      setTimeout(() => inp.classList.remove('error'), 800);
      inp.focus();
      return;
    }

    // â”€â”€ Challenge mode branch â”€â”€
    if (challengeActive) {
      if (Date.now() >= challengeEndTime) { endChallenge(); return; }
      const guess   = parseInt(inp.value, 10);
      const correct = guess === answer;
      challengeHands.push({ correct, userScore: guess, actualScore: answer, timeMs: Date.now() - dealTime });
      updateStreak(correct);
      stopTimer();

      const correctCount = challengeHands.filter(h => h.correct).length;
      document.getElementById('challenge-score-display').textContent = `${correctCount} correct`;

      const box = document.getElementById('result-box');
      box.className = 'result-box ' + (correct ? 'correct' : 'incorrect');
      document.getElementById('result-icon').textContent = correct ? 'âœ“' : 'âœ—';
      document.getElementById('result-msg').textContent  = correct
        ? `Correct! (${answer} pts)` : `It was ${answer} â€” you entered ${guess}`;
      document.getElementById('result-sub').textContent = '';
      document.getElementById('result-area').style.display = 'block';

      setTimeout(() => {
        if (!challengeActive) return;
        document.getElementById('result-area').style.display = 'none';
        if (Date.now() >= challengeEndTime) endChallenge();
        else deal();
      }, 800);
      return;
    }

    // â”€â”€ Normal practice branch â”€â”€
    const guess   = parseInt(inp.value, 10);
    const correct = guess === answer;

    if (!handScored) {
      handScored = true;
      stopTimer();
      updateStreak(correct);
      addRecord({ hand: hand.map(c => ({...c})), starter: {...starter}, userScore: guess, actualScore: answer, timeMs: Date.now() - dealTime });
    }

    const box = document.getElementById('result-box');
    box.className = 'result-box ' + (correct ? 'correct' : 'incorrect');
    document.getElementById('result-icon').textContent = correct ? 'âœ“' : 'âœ—';
    document.getElementById('result-msg').textContent  = correct ? `Correct! The score is ${answer}.` : 'Not quite!';
    document.getElementById('result-sub').textContent  = correct ? '' : `You entered ${guess}. The actual score is ${answer}.`;

    document.getElementById('result-area').style.display = 'block';
    document.getElementById('show-breakdown-btn').style.display = 'inline-block';

    detailsOpen = false;
    document.getElementById('details-area').style.display = 'none';
    document.getElementById('show-breakdown-btn').textContent = 'Show Breakdown';

    setTimeout(() => document.getElementById('new-hand-btn').focus(), 0);
  }

  function toggleBreakdown() {
    detailsOpen = !detailsOpen;
    const det = document.getElementById('details-area');
    const btn = document.getElementById('show-breakdown-btn');
    if (detailsOpen) {
      det.innerHTML = buildBreakdownHTML(sections, answer);
      det.className = 'breakdown-box';
      det.style.display = 'block';
      btn.textContent = 'Hide Breakdown';
    } else {
      det.style.display = 'none';
      btn.textContent = 'Show Breakdown';
    }
  }

  document.getElementById('check-btn').addEventListener('click', checkScore);
  document.getElementById('new-hand-btn').addEventListener('click', deal);
  document.getElementById('start-challenge-btn').addEventListener('click', startChallenge);
  document.getElementById('show-breakdown-btn').addEventListener('click', toggleBreakdown);
  document.getElementById('reset-btn').addEventListener('click', resetHistory);
  document.getElementById('score-input').addEventListener('keydown', e => { if (e.key === 'Enter') checkScore(); });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CRIB DISCARD TAB
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let cribRoleMode     = 'random';    // 'pone' | 'random' | 'dealer'
  let crib6 = [];
  let cribIsDealer     = false;
  let cribSelected     = new Set();   // indices 0â€“5
  let cribEvaluated    = false;

  function setCribRoleMode(mode) {
    cribRoleMode = mode;
    document.querySelectorAll('.role-toggle-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.mode === mode);
    });
    dealCribPractice();
  }

  function dealCribPractice() {
    const deck   = shuffle(createDeck());
    crib6        = deck.slice(0, 6).sort((a, b) => rankIdx(a.rank) - rankIdx(b.rank));
    cribIsDealer = cribRoleMode === 'dealer' ? true
                 : cribRoleMode === 'pone'   ? false
                 : Math.random() < 0.5;
    cribSelected.clear();
    cribEvaluated = false;

    document.getElementById('crib-deal-section').style.display = '';
    document.getElementById('crib-results').style.display = 'none';
    document.getElementById('crib-results').innerHTML = '';
    document.getElementById('crib-new-btn').style.display = 'none';
    document.getElementById('crib-submit-btn').style.display = '';

    renderCribRole();
    renderCribCards();
    updateCribSubmitBtn();
  }

  function renderCribRole() {
    const role    = cribIsDealer ? 'DEALER' : 'PONE';
    const roleCls = cribIsDealer ? 'dealer' : 'pone';
    const tip     = cribIsDealer
      ? 'The crib scores for you â€” send your best cards!'
      : 'The crib scores for your opponent â€” keep the crib cards weak!';
    document.getElementById('crib-role-area').innerHTML = `
      <div class="role-area">
        <div class="role-badge ${roleCls}">You are the ${role}</div>
        <div class="role-tip">${tip}</div>
      </div>`;
  }

  function cribCardWrapHTML(card, idx) {
    const isSel     = cribSelected.has(idx);
    const isKept    = cribSelected.size === 2 && !isSel;
    const wrapClass = ['crib-card-wrap', isSel ? 'selected' : '', isKept ? 'kept' : ''].filter(Boolean).join(' ');
    const badge     = isSel  ? '<div class="card-badge crib-badge">Crib</div>'
                   : isKept  ? '<div class="card-badge keep-badge">Keep</div>'
                   : '';
    return `<div class="${wrapClass}" onclick="toggleCribCard(${idx})">
      ${badge}
      ${cardHTML(card)}
    </div>`;
  }

  function renderCribCards() {
    document.getElementById('crib-cards-row').innerHTML =
      crib6.map((c, i) => cribCardWrapHTML(c, i)).join('');

    const n = cribSelected.size;
    const statusEl = document.getElementById('crib-status');
    if (n === 2) {
      statusEl.textContent = '2 cards selected â€” ready to discard!';
      statusEl.style.color = '#2ecc71';
    } else {
      statusEl.textContent = `Select ${2 - n} more card${2 - n > 1 ? 's' : ''} to discard (${n}/2)`;
      statusEl.style.color = 'rgba(255,255,255,0.6)';
    }
  }

  function toggleCribCard(idx) {
    if (cribEvaluated) return;
    if (cribSelected.has(idx)) {
      cribSelected.delete(idx);
    } else if (cribSelected.size < 2) {
      cribSelected.add(idx);
    }
    renderCribCards();
    updateCribSubmitBtn();
  }

  function updateCribSubmitBtn() {
    const btn = document.getElementById('crib-submit-btn');
    const n   = cribSelected.size;
    btn.disabled    = n !== 2;
    btn.textContent = n === 2 ? 'Discard Selected Cards â†’' : `Select 2 cards to discard (${n}/2)`;
  }

  function getRating(rank, total) {
    if (rank === 1)                          return { cls: 'optimal',   icon: 'ğŸ¯', label: 'Optimal!'  };
    if (rank <= 3)                           return { cls: 'excellent', icon: 'âœ“âœ“', label: 'Excellent!' };
    if (rank <= Math.ceil(total / 2))        return { cls: 'good',      icon: 'âœ“',  label: 'Good'       };
    if (rank <= total - 2)                   return { cls: 'fair',      icon: '~',  label: 'Fair'       };
    return                                          { cls: 'poor',      icon: 'âœ—',  label: 'Poor'       };
  }

  function evaluateAllDiscards(cards6, isDealer) {
    const deck6Set = new Set(cards6.map(c => c.rank + c.suit));
    const cuts = createDeck().filter(c => !deck6Set.has(c.rank + c.suit)); // 46 cards

    return combos([0,1,2,3,4,5], 2).map(dIdxs => {
      const kIdxs    = [0,1,2,3,4,5].filter(i => !dIdxs.includes(i));
      const kept     = kIdxs.map(i => cards6[i]);
      const discards = dIdxs.map(i => cards6[i]);

      const handScores = cuts.map(cut => scoreHand(kept, cut).total);

      const handMin = Math.min(...handScores);
      const handMax = Math.max(...handScores);
      const handAvg = handScores.reduce((s, x) => s + x, 0) / cuts.length;

      // Full crib avg: your 2 discards + every possible opponent pair + every possible cut
      // For each cut ci, opponent pair is any 2 cards from the remaining 45 (cuts minus cut)
      const N = cuts.length; // 46
      let cribSum = 0;
      for (let ci = 0; ci < N; ci++) {
        const cut = cuts[ci];
        for (let oi = 0; oi < N; oi++) {
          if (oi === ci) continue;
          for (let oj = oi + 1; oj < N; oj++) {
            if (oj === ci) continue;
            cribSum += scoreCrib5Fast(discards[0], discards[1], cuts[oi], cuts[oj], cut);
          }
        }
      }
      // denominator: N cuts Ã— C(N-1, 2) opponent pairs = 46 Ã— 990 = 45,540
      const cribAvg = cribSum / (N * (N - 1) * (N - 2) / 2);

      return { dIdxs, kIdxs, kept, discards, handMin, handMax, handAvg, cribAvg };
    }).sort((a, b) => {
      const netA = isDealer ? a.handAvg + a.cribAvg : a.handAvg - a.cribAvg;
      const netB = isDealer ? b.handAvg + b.cribAvg : b.handAvg - b.cribAvg;
      return netB - netA;
    });
  }

  function submitCribDiscards() {
    if (cribSelected.size !== 2 || cribEvaluated) return;
    cribEvaluated = true;

    const discardIdxs = [...cribSelected].sort((a, b) => a - b);
    const allOpts     = evaluateAllDiscards(crib6, cribIsDealer);
    const playerOpt   = allOpts.find(o =>
      o.dIdxs.includes(discardIdxs[0]) && o.dIdxs.includes(discardIdxs[1]));
    const playerRank  = allOpts.indexOf(playerOpt) + 1;

    renderCribResult({ discardIdxs, playerOpt, playerRank, allOpts });
  }

  function renderCribResult({ discardIdxs, playerOpt, playerRank, allOpts }) {
    const rating   = getRating(playerRank, allOpts.length);
    const bestOpt  = allOpts[0];
    const role     = cribIsDealer ? 'DEALER' : 'PONE';
    const f2 = n => n.toFixed(2);

    // Composite score: dealer adds crib, pone subtracts crib
    const netScore = opt => cribIsDealer
      ? opt.handAvg + opt.cribAvg
      : opt.handAvg - opt.cribAvg;

    // Delta note (score-based)
    const scoreDelta = netScore(bestOpt) - netScore(playerOpt);
    const deltaNote = scoreDelta < 0.01
      ? 'Your score matched the best possible!'
      : `Your score was ${f2(netScore(playerOpt))} â€” best was ${f2(netScore(bestOpt))} (${f2(scoreDelta)} pts higher).`;

    // Crib quality note (full 4-card crib avg â€” typical range ~4â€“7)
    let cribQualCls, cribQualNote;
    if (cribIsDealer) {
      if (playerOpt.cribAvg >= 6.5)    { cribQualCls = 'crib-good'; cribQualNote = 'Excellent crib cards!'; }
      else if (playerOpt.cribAvg >= 5) { cribQualCls = 'crib-ok';   cribQualNote = 'Decent crib cards.'; }
      else                             { cribQualCls = 'crib-bad';  cribQualNote = 'Weak crib cards.'; }
    } else {
      if (playerOpt.cribAvg < 4.5)     { cribQualCls = 'crib-good'; cribQualNote = 'Safe â€” low expected crib!'; }
      else if (playerOpt.cribAvg < 5.5){ cribQualCls = 'crib-ok';   cribQualNote = 'Reasonably safe discards.'; }
      else                             { cribQualCls = 'crib-bad';  cribQualNote = 'Risky â€” high expected crib!'; }
    }

    // Ranking table rows
    const tableRows = allOpts.map((opt, i) => {
      const isYou  = opt.dIdxs.includes(discardIdxs[0]) && opt.dIdxs.includes(discardIdxs[1]);
      const hMinis = opt.kept.map(miniCardHTML).join('');
      const dMinis = opt.discards.map(miniCardHTML).join('');
      return `<div class="rank-row ${isYou ? 'you-row' : ''}">
        <div class="rank-row-top">
          <span class="rank-num">#${i + 1}</span>
          <div class="rank-cards-group">
            <div class="rank-mini-hand">${hMinis}</div>
            <span class="rank-sep">â†’</span>
            <div class="rank-mini-discard">${dMinis}</div>
          </div>
          <span class="rank-score">${f2(netScore(opt))}</span>
        </div>
        <div class="rank-row-stats">
          <span class="rank-stat-item"><span class="rank-stat-lbl">Avg</span><span class="rank-stat-val rank-avg-val">${f2(opt.handAvg)}</span></span>
          <span class="rank-stat-item"><span class="rank-stat-lbl">Min</span><span class="rank-stat-val">${opt.handMin}</span></span>
          <span class="rank-stat-item"><span class="rank-stat-lbl">Max</span><span class="rank-stat-val">${opt.handMax}</span></span>
          <span class="rank-stat-item"><span class="rank-stat-lbl">Crib</span><span class="rank-stat-val rank-crib-val">${f2(opt.cribAvg)}</span></span>
        </div>
      </div>`;
    }).join('');

    const cribDirHint = cribIsDealer ? '(Avg Hand + Avg Crib)' : '(Avg Hand - Avg Crib)';

    document.getElementById('crib-results').innerHTML = `
      <!-- Hand + Discards -->
      <div class="crib-result-cards">
        <div class="hand-group">
          <div class="group-label">Your Hand</div>
          <div class="cards-row">${playerOpt.kept.map(cardHTML).join('')}</div>
        </div>
        <div class="crib-divider"></div>
        <div class="hand-group">
          <div class="group-label">Your Crib Discards</div>
          <div class="cards-row">${playerOpt.discards.map(cardHTML).join('')}</div>
        </div>
      </div>

      <!-- Stats summary row -->
      <div class="crib-stats-row">
        <span class="crib-stat-item"><span class="crib-stat-lbl">Score</span><span class="crib-stat-val" style="color:#fff">${f2(netScore(playerOpt))}</span></span>
        <span class="crib-stat-sep">Â·</span>
        <span class="crib-stat-item"><span class="crib-stat-lbl">Avg</span><span class="crib-stat-val">${f2(playerOpt.handAvg)}</span></span>
        <span class="crib-stat-sep">Â·</span>
        <span class="crib-stat-item"><span class="crib-stat-lbl">Min</span><span class="crib-stat-val">${playerOpt.handMin}</span></span>
        <span class="crib-stat-sep">Â·</span>
        <span class="crib-stat-item"><span class="crib-stat-lbl">Max</span><span class="crib-stat-val">${playerOpt.handMax}</span></span>
        <span class="crib-stat-sep">Â·</span>
        <span class="crib-stat-item"><span class="crib-stat-lbl">Crib Avg</span><span class="crib-stat-val">${f2(playerOpt.cribAvg)}</span></span>
        <span class="crib-stat-sep">Â·</span>
        <span class="crib-stat-item"><span class="crib-stat-lbl">Rank</span><span class="crib-stat-val">#${playerRank} of ${allOpts.length}</span></span>
      </div>

      <!-- How did you do -->
      <div class="eval-section">
        <div class="eval-section-title">How Did You Do?</div>
        <div class="eval-grade ${rating.cls}">${rating.icon} ${rating.label} â€” Ranked #${playerRank} of ${allOpts.length}</div>
        <div class="eval-rank-note">${deltaNote}</div>
        <div class="eval-delta-note">Crib: <span class="${cribQualCls}">${cribQualNote}</span></div>
      </div>

      <!-- All 15 options -->
      <div class="eval-section">
        <div class="eval-section-title">All 15 Discard Options â€” sorted by score Â· ${cribDirHint}</div>
        <div class="rank-table-wrap">${tableRows}</div>
      </div>
    `;

    document.getElementById('crib-results').style.display = 'block';
    document.getElementById('crib-deal-section').style.display = 'none';
    document.getElementById('crib-submit-btn').style.display = 'none';
    document.getElementById('crib-new-btn').style.display = 'block';

    setTimeout(() => document.getElementById('crib-new-btn').focus(), 0);
  }

  document.getElementById('crib-submit-btn').addEventListener('click', submitCribDiscards);
  document.getElementById('crib-new-btn').addEventListener('click', dealCribPractice);

  // Difficulty toggle button listeners
  document.querySelectorAll('#diff-toggle .role-toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => setDifficulty(+btn.dataset.min));
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  Init
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  loadHistory();
  renderHistory();
  applyTheme(currentTheme);
  // Restore saved difficulty button state
  document.querySelectorAll('#diff-toggle .role-toggle-btn').forEach(btn => {
    btn.classList.toggle('active', +btn.dataset.min === minScore);
  });
  deal();
  // Restore last active tab
  const savedTab = localStorage.getItem('crib-active-tab');
  if (savedTab === 'crib') switchTab('crib');

  // Register service worker for PWA / offline support
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
</script>

</body>
</html>
